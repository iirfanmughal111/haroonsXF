<?xml version="1.0" encoding="utf-8"?>
<template_modifications>
  <modification type="public" template="account_preferences" modification_key="trakt_tv_account_preferences_region" description="Add input (region code)" execution_order="10" enabled="1" action="str_replace">
    <find><![CDATA[<xf:macro template="helper_account" name="email_options_row" ]]></find>
    <replace><![CDATA[<xf:if is="!in_array('', $xf.options.traktTvThreads_watchProviderRegions)">
				<xf:selectrow name="option[nick97_tv_trakt_watch_region]" value="{$xf.visitor.Option.nick97_tv_trakt_watch_region}"
					label="{{ phrase('nick97_tv_trakt_watch_region') }}">

					<xf:options source="$traktTvWatchRegions" />
				</xf:selectrow>
			</xf:if>

$0]]></replace>
  </modification>
  <modification type="public" template="category_view" modification_key="traktTV16" description="Adds add tv show button to category display (template: snog_tv_add_show)" execution_order="10" enabled="1" action="str_replace">
    <find><![CDATA[<xf:breadcrumb source="$category.getBreadcrumbs(false)" />]]></find>
    <replace><![CDATA[$0
<xf:if is="in_array($category.node_id, $xf.options.traktTvThreads_category)">
	<xf:include template="trakt_tv_add_show" />
</xf:if>]]></replace>
  </modification>
  <modification type="public" template="category_view" modification_key="traktTV44" description="Adds required Trakt credit at bottom of category" execution_order="10" enabled="1" action="str_replace">
    <find><![CDATA[<div class="block-container">
			<div class="block-body">
				<xf:macro template="forum_list" name="node_list"
					arg-children="{$nodeTree}"
					arg-extras="{$nodeExtras}"
					arg-depth="2" />
			</div>
		</div>]]></find>
    <replace><![CDATA[$0
<xf:if is="in_array($category.node_id, $xf.options.traktTvThreads_category)">
	<span class="tvhint">{{ phrase('trakt_tv_information')}}</span>
</xf:if>

]]></replace>
  </modification>
  <modification type="public" template="forum_post_thread" modification_key="traktTV25" description="Changes post link for episode forums" execution_order="10" enabled="1" action="str_replace">
    <find><![CDATA[link('forums/post-thread', $forum)]]></find>
    <replace><![CDATA[($forum.TVForum is not empty && $forum.TVForum.tv_parent_id) ? link('forums/newepisode', $forum) : $0]]></replace>
  </modification>
  <modification type="public" template="forum_view" modification_key="traktTV21A" description="Changes post thread button to add season for TV forums (template: trakt_tv_add_season) 2.2" execution_order="10" enabled="1" action="preg_replace">
    <find><![CDATA[/<xf:pageaction if="\$forum.canCreateThread().+pageaction>/isU]]></find>
    <replace><![CDATA[<xf:if is="$forum.TVForum is not empty && !$forum.TVForum.tv_parent_id">
	<xf:include template="trakt_tv_add_season" />
<xf:else />
	$0
</xf:if>]]></replace>
  </modification>
  <modification type="public" template="forum_view" modification_key="traktTV22" description="Adds post thread button back in a new position (template: trakt_tv_post_thread)" execution_order="10" enabled="1" action="str_replace">
    <find><![CDATA[<xf:ad position="forum_view_above_thread_list" arg-forum="{$forum}" />]]></find>
    <replace><![CDATA[$0
<xf:if is="$forum.TVForum is not empty && !$forum.TVForum.tv_parent_id">
	<xf:if is="$forum.canCreateThread()">
		<xf:include template="trakt_tv_post_thread" />
	</xf:if>
</xf:if>]]></replace>
  </modification>
  <modification type="public" template="forum_view" modification_key="traktTV23A" description="Changes post thread to post episode in season forums (template: trakt_tv_add_episode) 2.2" execution_order="10" enabled="1" action="preg_replace">
    <find><![CDATA[/<xf:pageaction if="\$forum.canCreateThread().+pageaction>/isU]]></find>
    <replace><![CDATA[<xf:if is="$forum.TVForum is not empty && $forum.TVForum.tv_parent_id">
	<xf:include template="trakt_tv_add_episode" />
<xf:else />
	$0
</xf:if>]]></replace>
  </modification>
  <modification type="public" template="forum_view" modification_key="traktTV29A" description="Removes quick new thread prompt for season forums 2.2" execution_order="10" enabled="1" action="preg_replace">
    <find><![CDATA[/<xf:macro name="{{ \$templateOverrides.quick_thread_macro.+>/isU]]></find>
    <replace><![CDATA[<xf:if is="$forum.TVForum is empty || !$forum.TVForum.tv_season">
	$0
</xf:if>]]></replace>
  </modification>
  <modification type="public" template="forum_view" modification_key="traktTV39" description="Adds filter removal links (template: trakt_tv_filter_removal)" execution_order="10" enabled="1" action="str_replace">
    <find><![CDATA[<xf:if is="$filters.last_days AND {$dateLimits.{$filters.last_days}}">]]></find>
    <replace><![CDATA[<xf:include template="trakt_tv_filter_removal" />
$0]]></replace>
  </modification>
  <modification type="public" template="forum_view" modification_key="traktTV4" description="Changes post thread to post TV show" execution_order="10" enabled="1" action="str_replace">
    <find><![CDATA[{{ phrase('post_thread') }}]]></find>
    <replace><![CDATA[<xf:if is="in_array($forum.node_id, $xf.options.traktTvThreads_forum) && !$xf.options.traktTvThreads_mix">
	{{ phrase('trakt_tv_post_new_show') }}
<xf:else />
$0	
</xf:if>
]]></replace>
  </modification>
  <modification type="public" template="forum_view" modification_key="traktTV41" description="Removes forum description from default display" execution_order="10" enabled="1" action="str_replace">
    <find><![CDATA[<xf:description>{$forum.Node.description|raw}</xf:description>]]></find>
    <replace><![CDATA[<xf:if is="$forum.TVForum is empty">
	$0
</xf:if>]]></replace>
  </modification>
  <modification type="admin" template="helper_criteria" modification_key="traktTVAdmin2" description="Adds TV thread started to criteria" execution_order="10" enabled="1" action="str_replace">
    <find><![CDATA[<!--[XF:user:content_after_messages]-->]]></find>
    <replace><![CDATA[<xf:option name="user_criteria[tv_posted][rule]" value="tv_posted" selected="{$criteria.tv_posted}"
	label="{{ phrase('trakt_tv_started_x_threads') }}">
	<xf:numberbox name="user_criteria[tv_posted][data][tv]" value="{$criteria.tv_posted.tv}"
		size="5" min="0" step="1" />
</xf:option>
$0]]></replace>
  </modification>
  <modification type="public" template="node_list_forum" modification_key="traktTV17" description="Changes node icon to TV poster (template: trakt_tv_node_poster)" execution_order="10" enabled="1" action="preg_replace">
    <find><![CDATA[/<span class="node-icon" aria-hidden="true">(.*?)<\/span>/s]]></find>
    <replace><![CDATA[<xf:if is="$node.TVForum is not empty">
	<xf:include template="trakt_tv_node_poster" />
<xf:else />
	$0
</xf:if>]]></replace>
  </modification>
  <modification type="public" template="node_list_forum" modification_key="traktTV19" description="Adds TV show info to forum list (template: trakt_tv_node_info)" execution_order="10" enabled="1" action="str_replace">
    <find><![CDATA[<xf:if is="$descriptionDisplay != 'none' && $node.description">]]></find>
    <replace><![CDATA[<xf:if is="$node.TVForum is not empty">
	<xf:include template="trakt_tv_node_info" />
</xf:if>
$0]]></replace>
  </modification>
  <modification type="public" template="node_list_forum" modification_key="traktTV33" description="Adds tv show rating stars to node list" execution_order="10" enabled="1" action="str_replace">
    <find><![CDATA[<div class="node-stats">]]></find>
    <replace><![CDATA[$0
<xf:if is="!$node.TVForum.tv_parent_id && $node.TVForum.tv_id">
	<xf:macro template="rating_macros" name="stars" arg-rating="{$node.TVForum.tv_rating}"/>
</xf:if>
]]></replace>
  </modification>
  <modification type="public" template="post_macros" modification_key="traktTV32" description="Removes reply link from TV thread" execution_order="10" enabled="1" action="preg_replace">
    <find><![CDATA[/<xf:if is="\$thread.canReply().+xf:if>.+xf:if>/isU]]></find>
    <replace><![CDATA[<xf:if is="$thread.traktTV is empty || !$post.isFirstPost()">
	$0
</xf:if>]]></replace>
  </modification>
  <modification type="public" template="post_macros" modification_key="trakt_tv_post_macros_action_bar" description="Adds update episode link to episode posts (template: trakt_tv_post_macros_action_bar)" execution_order="10" enabled="1" action="str_replace">
    <find><![CDATA[<xf:if is="$post.edit_count && $post.canViewHistory()">]]></find>
    <replace><![CDATA[<xf:include template="trakt_tv_post_macros_action_bar" />
			$0]]></replace>
  </modification>
  <modification type="public" template="quick_reply_macros" modification_key="traktTV11" description="Adds tv episode input to quick reply (template: trakt_tv_quick_reply_episode)" execution_order="10" enabled="1" action="preg_replace">
    <find><![CDATA[#<xf:editor name="message".*\/>#Us]]></find>
    <replace><![CDATA[<xf:if is="$thread && $thread.traktTV is not empty && !$thread.traktTV.tv_episode">
	$0
	<xf:include template="trakt_tv_quick_reply_episode" />
<xf:else />
	$0
</xf:if>]]></replace>
  </modification>
  <modification type="public" template="quick_reply_macros" modification_key="traktTV13" description="Adds thread info to quick reply macro" execution_order="10" enabled="1" action="str_replace">
    <find><![CDATA[arg-message=""]]></find>
    <replace><![CDATA[$0
arg-thread=""]]></replace>
  </modification>
  <modification type="public" template="quick_reply_macros" modification_key="trakt_tv_quick_reply_macros_editor_macro_arg" description="Add editor macro thread arg" execution_order="10" enabled="1" action="str_replace">
    <find><![CDATA[arg-message="{$message}"]]></find>
    <replace><![CDATA[$0
							arg-thread="{$thread}"]]></replace>
  </modification>
  <modification type="public" template="search_result_thread" modification_key="trakt_tv_search_result_thread" description="Add poster to search results (NOTE: Replaced with own template if &quot;Replace search results template&quot; option enabled)" execution_order="10" enabled="1" action="str_replace">
    <find><![CDATA[<xf:avatar user="{$thread.User}" size="s" defaultname="{$thread.username}" />]]></find>
    <replace><![CDATA[<xf:if is="$thread.traktTV is not empty">
				<xf:include template="trakt_tv_search_result_thread_poster" />
			<xf:else />
			$0
			</xf:if>
]]></replace>
  </modification>
  <modification type="public" template="thcovers_cover_macros" modification_key="trakt_tv_thcovers_cover_macros" description="Add menu item" execution_order="10" enabled="1" action="str_replace">
    <find><![CDATA[<!--[XF:find_menu:bottom]-->]]></find>
    <replace><![CDATA[$0
						<xf:if is="{{ $cover.canSetImage() && $entity.getEntityContentType() == 'thread' && $entity.TV }}">
							<a href="{{ link('covers/tv-update', {'content_type': $entity.getEntityContentType(), 'content_id': $entity.getEntityId()}) }}"
							   rel="nofollow"
							   class="blockLink"
							   data-xf-click="overlay">
								{{ phrase('trakt_tv_check_for_new_backdrop_image') }}
							</a>
						</xf:if>]]></replace>
  </modification>
  <modification type="public" template="thread_view" modification_key="traktTV12" description="Adds thread info to quick reply macro call" execution_order="10" enabled="1" action="str_replace">
    <find><![CDATA[arg-message="{$thread.draft_reply.message}"]]></find>
    <replace><![CDATA[$0
					arg-thread="{$thread}"]]></replace>
  </modification>
  <modification type="public" template="thread_view" modification_key="traktTV15" description="Changes script for quick reply to allow clearing of other fields (js: nick97/TraktTV/message.min.js)" execution_order="10" enabled="1" action="str_replace">
    <find><![CDATA[<xf:js src="xf/message.js" min="1" />]]></find>
    <replace><![CDATA[<xf:if is="$thread.traktTV is not empty && !$thread.traktTV.tv_episode">
	<xf:js src="nick97/TraktTV/message.min.js" />
<xf:else />
	$0
</xf:if>]]></replace>
  </modification>
  <modification type="public" template="thread_view" modification_key="traktTV37" description="Adds add tv info to menu" execution_order="10" enabled="1" action="str_replace">
    <find><![CDATA[<!--[XF:thread_tools_menu:before_footer]-->]]></find>
    <replace><![CDATA[<xf:if is="$forum.forum_type_id == 'trakt_tv' && $xf.visitor.hasPermission('tvthreads_interface', 'add_info')">
	<xf:if is="!$thread.traktTV">
		<a href="{{ link('tvTrakt/addinfo', $thread) }}" data-xf-click="overlay" class="menu-linkRow">{{ phrase('trakt_tv_add_info') }}</a>
	</xf:if>
</xf:if>
$0]]></replace>
  </modification>
  <modification type="public" template="thread_view" modification_key="trakt_tv_thread_view_thread_tools_menu" description="Add button" execution_order="10" enabled="1" action="str_replace">
    <find><![CDATA[<!--[XF:thread_tools_menu:before_footer]-->]]></find>
    <replace><![CDATA[<xf:if is="{{ property('trakt_tv_posterUpdateButtonPosition') == 'thread_tools_menu' && $thread.traktTV && ($xf.visitor.is_admin || $xf.visitor.is_moderator) }}">
												<a href="{{ link('tvTrakt/poster', $thread.traktTV) }}" data-xf-click="overlay" class="menu-linkRow">
													{{ phrase('trakt_tv_check_poster') }}
												</a>
											</xf:if>
											$0]]></replace>
  </modification>
  <modification type="admin" template="tools_rebuild" modification_key="trakt_tv_tools_rebuild_ratings" description="Rebuild job" execution_order="10" enabled="1" action="str_replace">
    <find><![CDATA[<!--[XF:rebuild_bottom]-->]]></find>
    <replace><![CDATA[$0
<xf:include template="trakt_tv_tools_rebuild" />]]></replace>
  </modification>
  <modification type="admin" template="user_edit" modification_key="trakt_tv_user_edit_region" description="Add input (region code)" execution_order="10" enabled="1" action="str_replace">
    <find><![CDATA[<xf:selectrow name="user[timezone]" value="{$user.timezone}"]]></find>
    <replace><![CDATA[			<xf:if is="!in_array('', $xf.options.traktTvThreads_watchProviderRegions)">
				<xf:selectrow name="option[nick97_tv_trakt_watch_region]" value="{$user.Option.nick97_tv_trakt_watch_region}"
					label="{{ phrase('nick97_tv_trakt_watch_region') }}">

					<xf:options source="$traktTvWatchRegions" />
				</xf:selectrow>
			</xf:if>

$0]]></replace>
  </modification>
</template_modifications>
