!function(t,e,i,o){"use strict";XF.Message=XF.Message||{},XF.Message.insertMessages=function(e,i,o,n){XF.setupHtmlInsert(e,function(e,s,a){var r=i.find(".js-replyNoMessages");r.length&&r.xfFadeUp(),e.each(function(){this.tagName&&XF.Message.insertMessage(t(this),i,o)}),n&&n(e)})},XF.Message.insertMessage=function(t,e,i){var o=e.children().first();t.hide(),o.is("form")&&!i?t.insertAfter(o):i?e.append(t):e.prepend(t),t.xfFadeDown(),XF.activate(t)},XF.MessageLoaderClick=XF.Click.newHandler({eventNameSpace:"XFMessageLoaderClick",options:{href:null,messagesContainer:"< .js-replyNewMessageContainer",selfContainer:".message",ascending:!0},loading:!1,init:function(){this.options.href||console.error("Must be initialized with a data-href attribute.")},click:function(t){if(t.preventDefault(),!this.loading){var e=this;XF.ajax("GET",this.options.href,{},XF.proxy(this,"loaded")).always(function(){e.loading=!1})}},loaded:function(e){if(e.html){var i=XF.findRelativeIf(this.options.messagesContainer,this.$target);XF.Message.insertMessages(e.html,i,this.options.ascending);var o=this.$target.closest(this.options.selfContainer);o.xfFadeUp(null,function(){o.remove()}),e.lastDate&&t('.js-quickReply input[name="last_date"]').val(e.lastDate)}}}),XF.QuickEditClick=XF.Click.newHandler({eventNameSpace:"XFQuickEdit",options:{editorTarget:null,editContainer:".js-editContainer",href:null,noInlineMod:0},$editorTarget:null,$editForm:null,href:null,loading:!1,init:function(){var t=this.options.editorTarget;t?(this.$editorTarget=XF.findRelativeIf(t,this.$target),this.$editorTarget.length?(this.href=this.options.href||this.$target.attr("href"),this.href||console.error("No edit URL specified.")):console.error("No quick edit target found")):console.error("No quick edit editorTarget specified")},click:function(t){if(this.$editorTarget&&this.href&&(t.preventDefault(),!this.loading)){this.loading=!0;var e={};this.options.noInlineMod&&(e._xfNoInlineMod=!0),XF.ajax("GET",this.href,e,XF.proxy(this,"handleAjax"),{skipDefaultSuccessError:!0})}},handleAjax:function(t){var e=this.$editorTarget,i=this;t.errors||t.exception?this.loading=!1:XF.setupHtmlInsert(t.html,function(t,o){t.hide().insertAfter(e),XF.activate(t),i.$editForm=t,t.on("ajax-submit:response",XF.proxy(i,"editSubmit")),t.find(".js-cancelButton").on("click",XF.proxy(i,"cancelClick")),t.find("input[type=hidden]").first().after('<input type="hidden" name="_xfInlineEdit" value="1" />'),e.xfFadeUp(null,function(){e.parent().addClass("is-editing"),t.xfFadeDown(XF.config.speed.normal,function(){t.trigger("quick-edit:shown");var e=t.find(i.options.editContainer);e.length&&!XF.isElementVisible(e)&&e.get(0).scrollIntoView(!0),i.loading=!1})}),t.trigger("quick-edit:show")})},editSubmit:function(t,e){if(!e.errors&&!e.exception){t.preventDefault(),e.message&&XF.flashMessage(e.message,3e3);var i=this.$editorTarget,o=this;XF.setupHtmlInsert(e.html,function(t,n,s){var a=o.options.editorTarget;a=a.replace(/<|\|/g,"").replace(/#[a-zA-Z0-9_-]+\s*/,"");var r=t.find(a);r.hide(),i.replaceWith(r),o.$editorTarget=r,XF.activate(r),o.stopEditing(!1,function(){r.xfFadeDown(),o.$editForm.trigger("quickedit:editcomplete",e)})})}},cancelClick:function(t){this.stopEditing(!0)},stopEditing:function(t,e){var i=this.$editorTarget,o=this.$editForm,n=this,s=function(){i.parent().removeClass("is-editing"),t&&i.xfFadeDown(),e&&e(),o.remove(),n.$editForm=null};o?o.xfFadeUp(null,s):s()}}),XF.QuoteClick=XF.Click.newHandler({eventNameSpace:"XFQuoteClick",options:{quoteHref:null,editor:".js-quickReply .js-editor"},init:function(){this.options.quoteHref||console.error("Must be initialized with a data-quote-href attribute.")},click:function(e){e.preventDefault();var i=this.options.quoteHref,o=t(e.target).parents(".tooltip--selectToQuote"),n=XF.unparseBbCode(o.data("quote-html"));XF.ajax("POST",i,{quoteHtml:n},XF.proxy(this,"handleAjax"),{skipDefaultSuccess:!0}),t(e.target).trigger("s2q:click");var s=XF.findRelativeIf(this.options.editor,this.$target);XF.focusEditor(s)},handleAjax:function(t){var e=XF.findRelativeIf(this.options.editor,this.$target);XF.insertIntoEditor(e,t.quoteHtml,t.quote)}}),XF.MultiQuote=XF.Element.newHandler({options:{href:"",messageSelector:"",addMessage:"",removeMessage:"",storageKey:""},mqStorage:null,mqOverlay:null,init:function(){this.initButton(),this.initControls()},initButton:function(){this.mqStorage=XF.LocalStorage.getJson(this.options.storageKey),this.hasQuotesStored()&&this.$target.show(),this.$target.on("click",XF.proxy(this,"buttonClick"))},buttonClick:function(t){if(t.preventDefault(),!this.options.href)return console.error("Multi-quote button must have a data-href attribute set to display selected quotes"),!1;XF.ajax("post",this.options.href,{quotes:XF.LocalStorage.get(this.options.storageKey)},XF.proxy(this,"loadOverlay"))},loadOverlay:function(t){if(t.html){var e=this;XF.setupHtmlInsert(t.html,function(t,i){var o=XF.getOverlayHtml({html:t,title:i.h1||i.title});o.find(".js-removeMessage").on("click",XF.proxy(e,"removeMessage")),o.find(".js-quoteMessages").on("click",XF.proxy(e,"quoteMessages")),e.mqOverlay=XF.showOverlay(o)})}},removeMessage:function(e){e.preventDefault();var i=t(e.target).closest(".nestable-item"),o=i.data("id"),n=this.mqOverlay;this.removeFromMultiQuote(o),i.xfFadeUp(XF.config.speed.fast,function(){i.remove()}),this.hasQuotesStored()||n.hide()},quoteMessages:function(e){e.preventDefault();var i=this.mqOverlay,o=i.getOverlay(),n=t.parseJSON(o.find('input[name="message_ids"]').val()),s=this.mqStorage;for(var a in n)if(n.hasOwnProperty(a)&&n[a].hasOwnProperty("id")){var r=n[a].id.split("-"),l=r[0],u=r[1];if(this.isValidQuote(s[l],u)){var c=s[l][u];!0!==c&&(c=XF.unparseBbCode(c)),n[a].value=c}}i.hide(),XF.ajax("post",this.options.href,{insert:n,quotes:XF.LocalStorage.get(this.options.storageKey)},XF.proxy(this,"insertMessages"))},isValidQuote:function(t,e){return!(void 0==t||!t.hasOwnProperty(e)||!0!==t[e]&&"string"!=typeof t[e])},insertMessages:function(e){t.each(e,function(e,i){if(!i.hasOwnProperty("quote")||!i.hasOwnProperty("quoteHtml"))return!0;XF.insertIntoEditor(t(".js-editor").parent(),i.quoteHtml,i.quote)});for(var i in this.mqStorage)this.removeFromMultiQuote(i)},initControls:function(){var e=".tooltip--selectToQuote, "+this.options.messageSelector,o=t(e).find(".js-multiQuote");t(i).on("click",e,XF.proxy(this,"controlClick"));var n=this;o.each(function(){var e=t(this),i=e.data("messageId");n.mqStorage.hasOwnProperty(i)&&(e.addClass("is-selected"),e.data("mqAction","remove"))})},controlClick:function(e){if(t(e.target).is(".js-multiQuote")){e.preventDefault();var i=t(e.target),o=i.data("mqAction"),n=i.data("messageId");switch(o){case"add":this.addToMultiQuote(n),XF.flashMessage(this.options.addMessage,3e3);break;case"remove":this.removeFromMultiQuote(n),XF.flashMessage(this.options.removeMessage,3e3)}t(e.target).trigger("s2q:click")}},addToMultiQuote:function(e){var i=t('.js-multiQuote[data-message-id="'+e+'"]'),o=i.parents(".tooltip--selectToQuote"),n=XF.unparseBbCode(o.data("quote-html"));i.length&&(i.addClass("is-selected"),i.data("mqAction","remove")),this.hasQuotesStored()?this.mqStorage[e]||(this.mqStorage[e]=[]):(this.mqStorage={},this.mqStorage[e]=[]),o.length?this.mqStorage[e].push(n):this.mqStorage[e].push(!0),this.updateMultiQuote()},removeFromMultiQuote:function(e){var i,o=String(e).match(/^(\d+)-(\d+)$/);o?(e=o[1],delete this.mqStorage[e][o[2]],this.getQuoteStoreCount(this.mqStorage[e])||delete this.mqStorage[e]):delete this.mqStorage[e],this.mqStorage[e]||(i=t('.js-multiQuote[data-message-id="'+e+'"]')).length&&(i.removeClass("is-selected"),i.data("mqAction","add")),this.updateMultiQuote()},getQuoteStoreCount:function(t){var e=0;for(var i in t)t.hasOwnProperty(i)&&(1!=t[i]&&"string"!=typeof t[i]||e++);return e},updateMultiQuote:function(){XF.LocalStorage.setJson(this.options.storageKey,this.mqStorage,!0),this.hasQuotesStored()?this.$target.show():this.$target.hide()},hasQuotesStored:function(){return this.mqStorage&&!t.isEmptyObject(this.mqStorage)}}),XF.SelectToQuote=XF.Element.newHandler({options:{messageSelector:""},$quickReply:null,timeout:null,processing:!1,isMouseDown:!1,tooltip:null,tooltipId:null,init:function(){e.getSelection&&(this.options.messageSelector?(this.$quickReply=t(".js-quickReply .js-editor").parent(),this.$quickReply.length&&(this.$target.on("mousedown",XF.proxy(this,"mouseDown")),this.$target.on("mouseup",XF.proxy(this,"mouseUp")),t(i).on("selectionchange",XF.proxy(this,"selectionChange")))):console.error("No messageSelector"))},mouseDown:function(){this.isMouseDown=!0},mouseUp:function(){this.isMouseDown=!1,this.trigger()},selectionChange:function(){this.isMouseDown||this.trigger()},trigger:function(){this.timeout||this.processing||(this.timeout=setTimeout(XF.proxy(this,"handleSelection"),100))},handleSelection:function(){this.processing=!0,this.timeout=null;var t=e.getSelection(),i=this.getValidSelectionContainer(t);i?this.showQuoteButton(i,t):this.hideQuoteButton();var o=this;setTimeout(function(){o.processing=!1},0)},getValidSelectionContainer:function(e){if(e.isCollapsed||!e.rangeCount)return null;var i=e.getRangeAt(0);if(this.adjustRange(i),!t.trim(i.toString()).length&&!i.cloneContents().querySelectorAll("img").length)return null;var o=t(i.commonAncestorContainer).closest(".js-selectToQuote");return o.length&&o.closest(this.options.messageSelector).find('.actionBar-action[data-xf-click="quote"]').length?t(i.startContainer).closest(".bbCodeBlock--quote, .js-noSelectToQuote").length||t(i.endContainer).closest(".bbCodeBlock--quote, .js-noSelectToQuote").length?null:o:null},adjustRange:function(i){var o=!1,n=!1,s=i.endContainer,a=t(s);if(0==i.endOffset&&(3!=s.nodeType||s.previousSibling||(a=a.parent()),n=a.closest(".bbCodeBlock--quote").length>0),n){var r=a.closest(".bbCodeBlock--quote");r.length&&(i.setEndBefore(r[0]),o=!0)}if(o){var l=e.getSelection();l.removeAllRanges(),l.addRange(i)}},showQuoteButton:function(t,e){var i=t.xfUniqueId();this.tooltip&&this.tooltipId===i||(this.hideQuoteButton(),this.createButton(t,i));var o=this.tooltip.getTooltip();o.data("quote-html",this.getSelectionHtml(e));var n=this.getButtonPositionMarker(e);this.tooltip.setPositioner([n.left,n.top]),this.tooltip.isShown()?this.tooltip.reposition():this.tooltip.show(),o.addClass("tooltip--selectToQuote")},getButtonPositionMarker:function(e){var i,o,n,s,a;i=t("<span />").text("​"),a=(o=e.getRangeAt(0).cloneRange()).getBoundingClientRect?o.getBoundingClientRect():null,o.collapse(!1),o.insertNode(i[0]);var r,l=0;do{if(r=!1,l++,i[0].parentNode&&"js-selectToQuoteEnd"==i[0].parentNode.className&&(i.insertBefore(i[0].parentNode),r=!0),i[0].previousSibling&&3==i[0].previousSibling.nodeType&&0==t.trim(i[0].previousSibling.textContent).length&&(i.insertBefore(i[0].previousSibling),r=!0),i[0].parentNode&&"LI"==i[0].parentNode.tagName&&!i[0].previousSibling){var u=i[0].parentNode;t(u).prev("li").length?(i.appendTo(t(u).prev("li")),r=!0):u.parentNode&&(i.insertBefore(u.parentNode),r=!0)}i[0].parentNode&&!i[0].previousSibling&&-1!=t.inArray(i[0].parentNode.tagName,["DIV","BLOCKQUOTE","PRE"])&&(i.insertBefore(i[0].parentNode),r=!0),i[0].previousSibling&&-1!=t.inArray(i[0].previousSibling.tagName,["OL","UL"])&&(t(i[0].previousSibling).find("li:last").append(i),r=!0),i[0].previousSibling&&-1!=t.inArray(i[0].previousSibling.tagName,["DIV","BLOCKQUOTE","PRE"])&&(i.appendTo(i[0].previousSibling),r=!0),i[0].previousSibling&&"BR"==i[0].previousSibling.tagName&&(i.insertBefore(i[0].previousSibling),r=!0)}while(r&&l<5);n=i.offset(),s=i.height(),i.parentsUntil("body").each(function(){var e,i,o=t(this);switch(o.css("overflow-x")){case"hidden":case"scroll":case"auto":i=(e=o.offset().left)+o.outerWidth(),n.left<e&&(n.left=e),i<n.left&&(n.left=i)}});var c=i.parent();return i.remove(),XF.browser.msie||c[0].normalize(),a&&!XF.isRtl()&&n.left-a.left>32&&(n.left-=16),n.top+=s,n},createButton:function(e,o){var n=e.closest(this.options.messageSelector),s=t("<span />"),a=n.find(".actionBar-action.js-multiQuote").clone();a.length&&(a.attr("title","").removeClass("is-selected").data("mqAction","add").css({marginLeft:0,background:"transparent"}).on("s2q:click",XF.proxy(this,"buttonClicked")),s.append(a),s.append(i.createTextNode(" | ")));var r=n.find('.actionBar-action[data-xf-click="quote"]').attr("title","").clone().css({marginLeft:0}).on("s2q:click",XF.proxy(this,"buttonClicked"));s.append(r),this.tooltip=new XF.TooltipElement(s,{html:!0,placement:"bottom"}),this.tooltipId=o},buttonClicked:function(){var t=e.getSelection();t.isCollapsed||(t.collapse(t.getRangeAt(0).commonAncestorContainer,0),this.hideQuoteButton())},hideQuoteButton:function(){var t=this.tooltip;t&&(t.destroy(),this.tooltip=null)},getSelectionHtml:function(t){var e,o,n=i.createElement("div");for(e=0,o=t.rangeCount;e<o;e++)n.appendChild(t.getRangeAt(e).cloneContents());return this.prepareSelectionHtml(n.innerHTML)},prepareSelectionHtml:function(t){return XF.adjustHtmlForRte(t)}}),XF.QuickReply=XF.Element.newHandler({options:{messageContainer:"",ascending:!0,filesContainer:".js-attachmentFiles",fileRow:".js-attachmentFile",insertAllRow:".js-attachmentInsertAllRow",submitHide:null},init:function(){this.$target.on("ajax-submit:before",XF.proxy(this,"beforeSubmit")),this.$target.on("ajax-submit:response",XF.proxy(this,"afterSubmit")),this.$target.on("draft:complete",XF.proxy(this,"onDraft"))},beforeSubmit:function(t,e){var i=e.submitButton;i&&"more_options"==i.attr("name")&&t.preventDefault()},afterSubmit:function(t,e){if(!e.errors&&!e.exception)if(t.preventDefault(),e.redirect)XF.redirect(e.redirect);else{this.$target.find('input[name="last_date"]').val(e.lastDate),this.getMessagesContainer().find(".js-newMessagesIndicator").remove(),this.insertMessages(e.html),XF.clearEditorContent(this.$target);var i=XF.getEditorInContainer(this.$target);i&&XF.Editor&&i instanceof XF.Editor&&i.blur();var o=this.$target,n=this.options,s=o.find(n.filesContainer);if(s.length){s.removeClass("is-active");var a=s.find(n.insertAllRow),r=s.find(n.fileRow);a.length&&a.removeClass("is-active"),r.length&&r.remove()}if(this.$target.trigger("preview:hide",[this]),this.options.submitHide)XF.findRelativeIf(this.options.submitHide,this.$target).hide();this.$target.find('input[name="season"]').val(""),this.$target.find('input[name="episode"]').val("")}},insertMessages:function(i){XF.Message.insertMessages(i,this.getMessagesContainer(),this.options.ascending,function(i){var o=i.first();if(o&&o.length){var n=o.dimensions(),s=t(e).scrollTop(),a=s+t(e).height();(n.top<s+50||n.top>a)&&t("html, body").animate({scrollTop:Math.max(0,n.top-60)},200)}})},getMessagesContainer:function(){var e=this.options.messageContainer;return e?XF.findRelativeIf(e,this.$target).first():t(".js-replyNewMessageContainer").first()},onDraft:function(t,e){if(e.hasNew&&e.html){if(this.getMessagesContainer().find(".js-newMessagesIndicator").length)return;this.insertMessages(e.html)}}}),XF.GuestCaptcha=XF.Element.newHandler({options:{url:"index.php?misc/captcha&with_row=1",target:".js-captchaContainer",skip:"[name=more_options]"},$captchaContainer:null,initialized:!1,init:function(){var t=this.$target;this.$captchaContainer=t.find(this.options.target),this.$captchaContainer.length&&(t.on("focusin",XF.proxy(this,"initializeCaptcha")),t.on("submit ajax-submit:before",XF.proxy(this,"submit")))},initializeCaptcha:function(e){var o=t(i.activeElement);if(!this.initialized&&!o.is(this.options.skip)){var n=this.$captchaContainer.data("row-type")||"";XF.ajax("get",XF.canonicalizeUrl(this.options.url),{row_type:n},XF.proxy(this,"showCaptcha")),this.initialized=!0}},showCaptcha:function(t){var e=this;XF.setupHtmlInsert(t.html,function(t,i,o){t.replaceAll(e.$captchaContainer),o()})},submit:function(e){if(!this.initialized&&!t(i.activeElement).is(this.options.skip))return e.preventDefault(),!1}}),XF.PostEdit=XF.Element.newHandler({init:function(){this.$target.on("quickedit:editcomplete",XF.proxy(this,"editComplete"))},editComplete:function(e,i){var o=this;XF.setupHtmlInsert(i.html,function(e,n,s){var a=i.threadChanges||{};if(a.title&&(t("h1.p-title-value").html(n.h1),t("title").html(n.title),XF.config.visitorCounts.title_count&&i.visitor&&(XF.pageTitleCache=n.title,XF.pageTitleCounterUpdate(i.visitor.total_unread))),a.customFields){var r=e.closest(".js-threadStatusField"),l=XF.findRelativeIf("< .block--messages | .js-threadStatusField",o.$target);r.length&&l.length&&l.xfFadeUp(XF.config.speed.fast,function(){l.replaceWith(r).xfFadeDown(XF.config.speed.fast)})}else e.find(".js-threadStatusField").remove()})}}),XF.Click.register("message-loader","XF.MessageLoaderClick"),XF.Click.register("quick-edit","XF.QuickEditClick"),XF.Click.register("quote","XF.QuoteClick"),XF.Element.register("multi-quote","XF.MultiQuote"),XF.Element.register("select-to-quote","XF.SelectToQuote"),XF.Element.register("quick-reply","XF.QuickReply"),XF.Element.register("guest-captcha","XF.GuestCaptcha"),XF.Element.register("post-edit","XF.PostEdit")}(jQuery,window,document);